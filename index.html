<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Matrix Chat</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js -->
  <script src="https://unpkg.com/alpinejs" defer></script>

  <!-- JS компоненти -->
  <script src="./login/login.js"></script>
  <script src="./sidebar/sidebar.js"></script>
  <script src="./chat.js"></script>
  <script src="./user/user.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="./index.css">
  <link rel="stylesheet" href="./login/login.css">
  <link rel="stylesheet" href="./sidebar/sidebar.css">

</head>

<body class="index-container bg-gray-100 flex justify-center">

  <div x-data="chatApp()" :class="accessToken ? '' : 'items-center'" class="flex w-full">

    <!-- Сайдбар (ROOMS) -->
    <div id="sidebar-container" class="w-1/4"></div>

    <!-- Основний чат -->
    <div class="chat-area p-6 flex flex-col space-y-4 w-2/4">
      <div id="login-container"></div>
      <div id="chat-container" class="flex-1"></div>
    </div>

    <!-- Users (КП2-9) -->
    <div id="user-container" class="w-1/4"></div>
  </div>


  <script>
    /* ========================================
       Завантаження компонентів
    ======================================== */
    document.addEventListener('DOMContentLoaded', () => {

      fetch('./login/login.html')
        .then(r => r.text())
        .then(html => document.getElementById('login-container').innerHTML = html);

      fetch('./sidebar/sidebar.html')
        .then(r => r.text())
        .then(html => document.getElementById('sidebar-container').innerHTML = html);

      fetch('./chat.html')
        .then(r => r.text())
        .then(html => document.getElementById('chat-container').innerHTML = html);

      fetch('./user/user.html')
        .then(r => r.text())
        .then(html => document.getElementById('user-container').innerHTML = html);
    });


    /* ========================================
       Функції Matrix (КП2-8 + КП2-9)
    ======================================== */

    async function login() {
      try {
        const res = await fetch('https://matrix.org/_matrix/client/r0/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'm.login.password',
            user: this.username,
            password: this.password
          })
        });

        const data = await res.json();

        if (data.access_token) {
          this.accessToken = data.access_token;
          this.userId = data.user_id;

          await this.fetchRoomsWithNames();
          await this.fetchMessages();
          await this.fetchRoomMembers();

          if (!this._syncInterval)
            this._syncInterval = setInterval(async () => {
              await this.fetchRoomsWithNames();
              await this.fetchMessages();
              await this.fetchRoomMembers();
            }, 5000);

        } else {
          alert("Login failed");
        }

      } catch (e) {
        console.error('Login error:', e);
      }
    }


    async function createRoom() {
      if (!this.newRoomName) return;

      try {
        const res = await fetch(
          "https://matrix.org/_matrix/client/r0/createRoom",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${this.accessToken}`
            },
            body: JSON.stringify({
              preset: "private_chat",
              name: this.newRoomName.trim()
            })
          }
        );

        const data = await res.json();

        if (data.room_id) {
          this.newRoomId = data.room_id;
          this.roomId = data.room_id;

          this.messages = [];
          this.lastSyncToken = "";

          await this.fetchRoomsWithNames();
          await this.fetchMessages();
          await this.fetchRoomMembers();
        }

      } catch (e) {
        console.error("createRoom error:", e);
      }
    }


    async function fetchRoomsWithNames() {
      if (!this.accessToken) return;

      try {
        const res = await fetch(
          "https://matrix.org/_matrix/client/r0/joined_rooms",
          { headers: { "Authorization": `Bearer ${this.accessToken}` } }
        );

        const data = await res.json();

        if (data.joined_rooms) {
          const arr = data.joined_rooms.map(async (roomId) => {

            try {
              const r = await fetch(
                `https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(roomId)}/state/m.room.name`,
                { headers: { "Authorization": `Bearer ${this.accessToken}` } }
              );

              const name = await r.json();
              return { roomId, name: name?.name || roomId };

            } catch {
              return { roomId, name: roomId };
            }
          });

          this.rooms = (await Promise.all(arr))
            .sort((a, b) => a.name.localeCompare(b.name));

          if (!this.roomId && this.rooms.length) {
            this.roomId = this.rooms[0].roomId;
            await this.fetchMessages();
            await this.fetchRoomMembers();
          }
        }

      } catch (e) {
        console.error("fetchRooms error:", e);
      }
    }


    async function sendMessage() {
      if (!this.newMessage || !this.roomId) return;
      const msg = this.newMessage.trim();
      this.newMessage = "";

      try {
        const url =
          `https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(this.roomId)}/send/m.room.message`;

        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${this.accessToken}`
          },
          body: JSON.stringify({ msgtype: "m.text", body: msg })
        });

        const data = await res.json();

        if (data.event_id)
          this.messages.push({ id: data.event_id, sender: this.userId, body: msg });

      } catch (e) {
        console.error("sendMessage error:", e);
      }
    }


    async function fetchMessages() {
      if (!this.accessToken || !this.roomId) return;

      try {
        const url = this.lastSyncToken
          ? `https://matrix.org/_matrix/client/r0/sync?since=${this.lastSyncToken}`
          : `https://matrix.org/_matrix/client/r0/sync`;

        const res = await fetch(url, {
          headers: { "Authorization": `Bearer ${this.accessToken}` }
        });

        const data = await res.json();

        if (data.next_batch)
          this.lastSyncToken = data.next_batch;

        const room = data.rooms?.join?.[this.roomId];
        room?.timeline?.events?.forEach(ev => {
          if (ev.type === "m.room.message")
            if (!this.messages.find(m => m.id === ev.event_id))
              this.messages.push({
                id: ev.event_id,
                body: ev.content?.body || "",
                sender: ev.sender
              });
        });

      } catch (e) {
        console.error("fetchMessages error:", e);
      }
    }


    /* ====================== КП2-9 ====================== */

    async function fetchRoomMembers() {
      if (!this.accessToken || !this.roomId) return;

      try {
        const res = await fetch(
          `https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(this.roomId)}/joined_members`,
          { headers: { "Authorization": `Bearer ${this.accessToken}` } }
        );

        const data = await res.json();

        this.roomMembers = Object.entries(data.joined || {}).map(([id, info]) => ({
          userId: id,
          displayName: info.display_name || id.split(":")[0].substring(1),
          avatarUrl: info.avatar_url || null
        }));

      } catch (e) {
        console.error("fetchRoomMembers error:", e);
        this.roomMembers = [];
      }
    }


    async function kickUser(userId) {
      try {
        const res = await fetch(
          `https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(this.roomId)}/kick`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${this.accessToken}`
            },
            body: JSON.stringify({
              user_id: userId,
              reason: "Removed by admin"
            })
          }
        );

        const data = await res.json();

        if (!data.errcode)
          await this.fetchRoomMembers();

      } catch (e) {
        console.error("kickUser error:", e);
      }
    }


    async function leaveRoom() {
      try {
        const res = await fetch(
          `https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(this.roomId)}/leave`,
          { method: "POST", headers: { "Authorization": `Bearer ${this.accessToken}` } }
        );

        await this.fetchRoomsWithNames();

        if (this.rooms.length) {
          this.roomId = this.rooms[0].roomId;
          await this.fetchMessages();
          await this.fetchRoomMembers();
        } else {
          this.roomId = "";
          this.messages = [];
          this.roomMembers = [];
        }

      } catch (e) {
        console.error("leaveRoom error:", e);
      }
    }

    /* Alpine.js */
    function chatApp() {
      return {
        username: "",
        password: "",
        accessToken: "",
        userId: "",
        roomId: "",
        joinRoomId: "",
        newRoomName: "",
        newRoomId: "",
        rooms: [],
        messages: [],
        newMessage: "",
        inviteUser: "",
        roomMembers: [],
        lastSyncToken: "",

        login,
        createRoom,
        fetchRoomsWithNames,
        sendMessage,
        fetchMessages,
        inviteUserToRoom,
        joinRoom,
        fetchRoomMembers,
        kickUser,
        leaveRoom,
        switchRoom,
        getRoomName
      };
    }

  </script>

</body>
</html>
